<!DOCTYPE html>
<meta charset="utf-8">

<head>
 <title>BugGuess: Tutorial</title>
 <!-- Prevent scaling -->
 <meta name="viewport" content="user-scalable=no, width=device-width" />
 <!-- Eliminate url and button bars if added to home screen -->
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <!-- Choose how to handle the phone status bar -->
 <meta names="apple-mobile-web-app-status-bar-style" content="black-translucent" />
 <!-- Specify a 320x460 start-up image. -->
 <link rel="apple-touch-startup-image" href="./images/bug_icon_large.png" />
 <!-- Choose a 144x144 image for the icon -->
 <link rel="apple-touch-icon" href="./images/bug_icon_sm.png" /> 


<!-- external libraries -->
<script src="static/lib/jquery-min.js" type="text/javascript"> </script>
<script src="static/lib/underscore-min.js" type="text/javascript"> </script>
<script src="static/lib/backbone-min.js" type="text/javascript"> </script>
<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<script src="static/lib/d3.v3.min.js" type="text/javascript"> </script> 
<script src="static/lib/d3-grid.js"></script>

<!-- experiment code -->
<script src="static/js/stimuli.js" type="text/javascript"> </script> 

<!-- stylesheets -->
<link rel=stylesheet href="static/css/style.css" type="text/css">

<script type="text/javascript">
   // To be called when there's a move event on the body itself:
   function BlockMove(event) {
     // Tell Safari not to move the window.
     event.preventDefault() ;
   }
</script>


</head>

<body ontouchmove="BlockMove(event);">

<div id="container">

<div class="container" id="stimArray"></div>
<div class="container" id="sideBar"></div>


<script>
var img_dir_prefix = "static/images/"
var button_dir = img_dir_prefix + "buttons/"

var condition = "manual"; // "automatic" grays out eliminated bugs on button press; "manual" requires subjects to gray out


var rects = [];

// iPad
//var screen_width = 2048,
//    screen_height = 1536;
// computer
var screen_width = 1280,
    screen_height = 1024;

var bug_width = 280,
    bug_height = 273;

var button_width = 149,
    button_height = 81;

var sidebar_width = 480;

var exemplar_images = ["house_red", "house_red", "house_blue", "house_blue2"];

// set 1
var features = {"f1":"red", "f2":"blue", "f3":"window"};

var exemplars = [
  {"id":"house_red",  "f1":1, "f2":0, "f3":0},
  {"id":"house_red2",  "f1":1, "f2":0, "f3":0},
  {"id":"house_blue", "f1":0, "f2":1, "f3":0},
  {"id":"house_blue2","f1":0, "f2":1, "f3":1}
  ];

var answer = exemplars[1];

//var button_images = ["red", "blue", "window", "ready"];
var buttons = [
  {id:"red", "feature":"f1"},
  {id:"blue", "feature":"f2"},
  {id:"window", "feature":"f3"}
//  {id:"ready"}
  ]


var rectGrid = d3.layout.grid()
  .bands()
  .nodeSize([bug_width, bug_height]) 
  .padding([40, 40]); // padding is absolute if nodeSize is used
  // .size([100,100])

var buttonGrid = d3.layout.grid()
  .bands()
  .rows(1)
  .nodeSize([button_width, button_height]) 
  .padding([50, 30]);

var bugs = d3.select("#stimArray").append("svg")
  .attr({
    width: screen_width-sidebar_width,
    height: screen_height-(2.5*button_height)
  }) 
  .attr("id", "bugArray")
  .append("g")
  .attr("transform", "translate(50,40)");


addImages(exemplars, img_dir_prefix);

var sidebar = d3.select("#sideBar").append("svg")
  .attr({
    width: sidebar_width,
    height: screen_height-(2.5*button_height)
  }) 
  .attr("id", "sidebar");


var rug = sidebar.append("g")
  .attr("id", "rug")
  .attr("transform", "translate(20,50)")
  .append("image")
  .attr("xlink:href", function(d) { return "static/images/dog.png"; })
  .attr({
    width: 349,
    height: 400
  })
  .style("opacity", 1)
  .on("mousedown", function(d) {
    d3.select(this).transition()
      .attr("width",349+50)
      .duration(1000) // this is 1s
      .delay(100);
    d3.select(this).transition()
      .attr("width",349)
      .duration(500)
      .delay(100);
  });

//function wiggle(d) {}

var callout = sidebar.append("g")
  .attr("id", "callout")
  .attr("transform", "translate(0,490)");

callout.append("image")
  .attr("xlink:href", function(d) { return "static/images/callout.svg"; })
  .attr({
    width: 300,
    height: 250
  })
  .style("opacity", 1);
  //.attr("transform", "translate(0,0)");

var text = callout
  .append("text")
  .attr("x", 32)
  .attr("y", 140)
  .attr("id", "blurb")
  .attr("style", "font-size: 50; font-family: Helvetica, sans-serif")
  .text("Woof?")
  .attr("fill", "black");

var buttonbar = d3.select("#container").append("svg")
  .attr({
    width: screen_width-sidebar_width,
    height: 2.5*button_height
  })
  .attr("id", "buttonArray")
  .append("g")
  .attr("transform", "translate(50,10)");

addButtons(buttons);




function addImages(exemplars, img_dir) { 
  //shuffle(exemplars);
  var rect = bugs.selectAll(".rect")
    .data(rectGrid(exemplars)); 
  console.log(rect)
  rect.enter().append("image")
    .attr("xlink:href", function(d) { return img_dir+d.id+".png"; })
    .attr("class", "rect")
    .attr("id", function(d) { return d.id; })
    .attr("width", rectGrid.nodeSize()[0])
    .attr("height", rectGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1e-6)
    .on("mousedown", function(d){
      // Determine if current line is visible
      var active   = rect.active ? false : true,
        newOpacity = active ? .2 : 1;
      // Hide or show the elements
      //d3.select("#"+d.id).style("opacity", newOpacity);
      // Update whether or not the elements are active
      rect.active = active;

      // do the 1-click test for now (otherwise use ready button state)
      if(d.id===answer.id) {
        var correct = d3.select("g").append("image")
          .attr("xlink:href", function(d) { return img_dir_prefix+"smiley.svg"; })
          .attr("id", "correct")
          .attr("x", 200)
          .attr("y", 200)
          .attr("height", 300)
          .attr("width", 300)
          .style("opacity", 1)
          .on("mousedown", function(d) { correct.remove() });
        correct.transition().duration(1000).delay(1000).style("opacity", 1e-6);
        text.text("Thanks!");
        text.transition().duration(1000).delay(1000).style("opacity", 1e-6);
      } else {
        d3.select("#"+d.id).style("opacity", newOpacity);
        //incorrect.style("opacity", 1);
        //incorrect.transition().delay(2000).style("opacity", 1e-6);
        var incorrect = d3.select("g").append("image")
          .attr("xlink:href", function(d) { return img_dir_prefix+"red_x.svg"; })
          .attr("id", "incorrect")
          .attr("x", d.x + 25)
          .attr("y", d.y)
          .attr("height", rectGrid.nodeSize()[0])
          .attr("width", rectGrid.nodeSize()[1])
          .style("opacity", 1)
          .on("mousedown", function(d) { incorrect.remove(); });
        incorrect.transition().duration(1000).delay(1000).style("opacity", 1e-6).remove();
        }
      });
  rect.transition()
    .delay(500)
    .attr("width", rectGrid.nodeSize()[0])
    .attr("height", rectGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1);
  rect.exit().transition()
    .style("opacity", 1e-6)
    .remove();
}

function addButtons(buttons) { 
  //shuffle(buttons);
  //var button = d3.select("#buttonArray")
  var button = buttonbar.selectAll(".button")
    .data(buttonGrid(buttons));
  button.enter().append("image")
    .attr("xlink:href", function(d) { return button_dir+d.id+".png"; })
    .attr("class", "button")
    .attr("id", function(d) { return d.id; })
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .style("opacity", 1e-6)
    .on("mousedown", function(d){
      // press once and remain active (unless ready button..)
      d3.select("#"+d.id).style("opacity", .2); //
      button.active = true;
      buttonPress(d);
    });
  button.transition()
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1);
  // could add a toggle 'ready' button here if desired
}



function buttonPress(b) {
  console.log(b);
  if(b.id=="ready") {
    d3.selectAll(".button")
      .transition()
      .style("opacity", 1e-6);
    // now treat the click on an exemplar as a guess... (modify the .on("click") function??)
  } else {
    // select the rects that do not have the answer's d[b.feature] 
    if(condition==="automatic") {
    d3.selectAll(".rect")
     .filter(function(d) {
       return d[b.feature] !== answer[b.feature];
     })
     .style("opacity", .2).attr("active", true);
   } else if(condition==="manual") {
     text.remove();
     var tmp = callout.append("text")
       .attr("x", 32)
       .attr("y", 140)
       .attr("style", "font-size: 40; font-family: Helvetica, sans-serif")
       .text("Feature: "+b.id+":"+answer[b.feature])
       .attr("fill", "black");
     tmp.transition()
       .delay(4000)
       .style("opacity", 1e-6)
       .remove();
     }
  }
  // OR show them a dialog with the correct feature in it
  // tooltip with image in it:
  // http://bl.ocks.org/jarobertson/1483052
}


//@ http://jsfromhell.com/array/shuffle [v1.0]
function shuffle(o) { 
    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
}

</script>

  </div>
 </body>
</html>
