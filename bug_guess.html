<!DOCTYPE html>
<meta charset="utf-8">

<head>
 <title>BugGuess</title>
 <!-- Prevent scaling -->
 <meta name="viewport" content="user-scalable=no, width=device-width" />
 <!-- Eliminate url and button bars if added to home screen -->
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <!-- Choose how to handle the phone status bar -->
 <meta names="apple-mobile-web-app-status-bar-style" content="black-translucent" />
 <!-- Specify a 320x460 start-up image. -->
 <link rel="apple-touch-startup-image" href="./images/bug_icon_large.png" />

 <!-- Choose a 144x144 image for the icon -->
 <link rel="apple-touch-icon" href="./images/bug_icon_sm.png" /> 

 <style>
  body {
   margin: 0px ;
   padding: 0px ;
   color: #222222;
   font-family: Helvetica;
   font-size: 14px ;
  }

 .point, .rect {
   fill: #222;
 }
div.tooltip {
  position: absolute;
  text-align: center;
  width: 120px;
  height: 33px;
  padding: 8px;
  font: 12px sans-serif;
  background: #ddd;
  border: solid 1px #aaa;
  border-radius: 8px;
  pointer-events: none;
}

</style>

<script type="text/javascript">
   // To be called when there's a move event on the body itself:
   function BlockMove(event) {
     // Tell Safari not to move the window.
     event.preventDefault() ;
   }
</script>

<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<script src="static/lib/d3.v3.min.js" type="text/javascript"> </script> 
<script src="static/js/d3-grid.js"></script>

</head>

<body ontouchmove="blockMove(event);">

<div id="container">

<script>
var img_dir_prefix = "static/images/";
var button_dir = img_dir_prefix + "buttons/";
// need a function to assign/counterbalance image_set
var image_set = "set1";
// var image_set = function getSet() {}


var screen_width = 2048,
    screen_height = 1536;

var bug_width = 330,
    bug_height = 280;

var button_width = 225,
    button_height = 118;


// set 1
var features = {"f1":"body", "f2":"eyes", "f3":"antennae", "f4":"star", "f5":"triangle", "f6":"feet", "f7":"wings", "f8":"freckles", "f9":"headband"};
// set 2
//var features = {"f1":"feet", "f2":"eyes", "f3":"triangle", "f4":"star", "f5":"wings", "f6":"headband", "f7":"body", "f8":"freckles", "f9":"antennae"};

var exemplars = [
  {"id":"A" , "f1":1 , "f2":0 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"B" , "f1":1 , "f2":1 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"C" , "f1":0 , "f2":1 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":1, "f10":0 },
  {"id":"D" , "f1":0 , "f2":1 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"E" , "f1":1 , "f2":0 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"F" , "f1":1 , "f2":1 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"G" , "f1":0 , "f2":1 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":1 , "f8":1 , "f9":0, "f10":0 },
  {"id":"H" , "f1":0 , "f2":1 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":1 , "f8":0 , "f9":0, "f10":0 },
  {"id":"I" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":0 , "f6":1 , "f7":0 , "f8":0 , "f9":1, "f10":0 },
  {"id":"J" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":0 , "f6":1 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"K" , "f1":0 , "f2":0 , "f3":1 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"L" , "f1":0 , "f2":0 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"M" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":1 , "f9":0, "f10":0 },
  {"id":"N" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"O" , "f1":0 , "f2":0 , "f3":1 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"P" , "f1":0 , "f2":0 , "f3":0 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  ];

var answer_ind = Math.floor((Math.random() * exemplars.length));
var answer = exemplars[answer_ind];

// varies with image set, so we need a function to return the right button set
var buttons = [
  {id:"body", "feature":"f1"},
  {id:"eyes", "feature":"f2"},
  {id:"antennae", "feature":"f3"},
  {id:"star", "feature":"f4"},
  {id:"triangle", "feature":"f5"},
  {id:"feet", "feature":"f6"},
  {id:"wings", "feature":"f7"},
  {id:"freckles", "feature":"f8"},
  {id:"headband", "feature":"f9"},
  {id:"mouth", "feature":"f10"}
//  {id:"ready"}
  ]


var rectGrid = d3.layout.grid()
  .bands()
  .nodeSize([bug_width, bug_height]) 
  .padding([10, 10]); // padding is absolute if nodeSize is used
  // .size([100,100])

var buttonGrid = d3.layout.grid()
  .bands()
  .rows(2)
  .nodeSize([button_width, button_height]) 
  .padding([20, 20]);

var svg = d3.select("body").append("svg")
  .attr({
    width: screen_width,
    height: screen_height-(2.5*button_height)
  }) 
  .attr("id", "bugArray")
  .append("g")
  .attr("transform", "translate(50,40)");


addImages(exemplars, img_dir_prefix+image_set+"/");


var svg = d3.select("body").append("svg")
  .attr({
    width: screen_width,
    height: 2.5*button_height
  })
  .attr("id", "buttonArray")
  .append("g")
  .attr("transform", "translate(50,10)");

addButtons(buttons);

var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

// var dialog = d3.select("g")
//   .append("svg:rect")
//   .attr("id", "dialog")
//   .attr("x", 490)
//   .attr("y", 470)
//   .attr("height", 200)
//   .attr("width", 400)
//   .attr("fill", "#999999")
//   .style("opacity", 1e-6);


function correctFeedback() {
  var correct = d3.select("g").append("image")
    .attr("xlink:href", function(d) { return img_dir_prefix+"smiley.svg"; })
    .attr("id", "correct")
    .attr("x", 490)
    .attr("y", 430)
    .attr("height", 400)
    .attr("width", 400)
    .style("opacity", 1e-6);
  correct.delay(3000).remove();
}

function incorrectFeedback() {
  var incorrect = d3.select("g").append("image")
    .attr("xlink:href", function(d) { return img_dir_prefix+"red_x.svg"; })
    .attr("id", "incorrect")
    .attr("x", 490)
    .attr("y", 430)
    .attr("height", 400)
    .attr("width", 400)
    .style("opacity", 1e-6)
    .on("click", function(d) {
      // if active then display for a second then make inactive again (but record click)
      var active = incorrect.active ? false : false;
      incorrect.active = false;
      d3.select("#"+d.id).style("opacity", 1e-6);
    });
  incorrect.delay(2000).remove();
}

function addImages(exemplars, img_dir) { 
  //shuffle(exemplars);
  var rect = svg.selectAll(".rect")
    .data(rectGrid(exemplars)); 
  console.log(rect)
  rect.enter().append("image")
    .attr("xlink:href", function(d) { return img_dir+d.id+".png"; })
    .attr("class", "rect")
    .attr("id", function(d) { return d.id; })
    .attr("width", rectGrid.nodeSize()[0])
    .attr("height", rectGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1e-6)
    .on("click", function(d){
      // Determine if current line is visible
      var active   = rect.active ? false : true,
        newOpacity = active ? .2 : 1;
      // Hide or show the elements
      d3.select("#"+d.id).style("opacity", newOpacity);
      // Update whether or not the elements are active
      rect.active = active;

      // do the 1-click test for now (otherwise use ready button state)
      if(d.id===answer.id) {
        correctFeedback();
        console.log("correct")
      } else {
        d3.select("#"+d.id).style("opacity", newOpacity);
        //incorrect.style("opacity", 1);
        //incorrect.transition().delay(2000).style("opacity", 1e-6);
        incorrectFeedback()
      }
    });
}

function addButtons(buttons) { 
  //shuffle(buttons);
  var button = svg.selectAll(".button")
    .data(buttonGrid(buttons));
  button.enter().append("image")
    .attr("xlink:href", function(d) { return button_dir+d.id+".png"; })
    .attr("class", "button")
    .attr("id", function(d) { return d.id; })
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .style("opacity", 1e-6)
    .on("click", function(d){
      // press once and remain active (unless ready button..)
      d3.select("#"+d.id).style("opacity", .2); //
      button.active = true;
      buttonPress(d);
    });
  button.transition()
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1);
  // could add a toggle 'ready' button here if desired
}


function buttonPress(b) {
  console.log(b);
  if(b.id=="ready") {
    d3.selectAll(".button")
      .transition()
      .style("opacity", 1e-6);
    // now treat the click on an exemplar as a guess... (modify the .on("click") function??)
  } else {
    // select the rects that do not have the answer's d[b.feature] 
    d3.selectAll(".rect")
     .filter(function(d) {
       return d[b.feature] !== answer[b.feature];
     })
     .style("opacity", .2).attr("active", true);
     // OR show them a dialog with the correct feature in it
     // tooltip with image in it:
     // http://bl.ocks.org/jarobertson/1483052

     // text is not showing (incorrect position?)
     // svg.select("g")
     //   .append("svg:text")
     //   .attr("transform", function(d) { 
     //      console.log(d);
     //      return "translate(" + (490+50) + "," + (470+50) + ")" ;
     //    })
     //   .attr("style", "font-size: 20; font-family: Helvetica, sans-serif")
     //   .text("Value of correct "+b.id+":"+answer[b.feature])
     //   .attr("fill", "black");
     // dialog.style("opacity", 1);
  }
}

//@ http://jsfromhell.com/array/shuffle [v1.0]
function shuffle(o) { 
  for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
  return o;
}

</script>
  
   </div>
 </body>
</html>