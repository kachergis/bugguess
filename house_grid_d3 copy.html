<!DOCTYPE html>
<meta charset="utf-8">

<head>
 <title>BugGuess: Tutorial</title>
 <!-- Prevent scaling -->
 <meta name="viewport" content="user-scalable=no, width=device-width" />
 <!-- Eliminate url and button bars if added to home screen -->
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <!-- Choose how to handle the phone status bar -->
 <meta names="apple-mobile-web-app-status-bar-style" content="black-translucent" />
 <!-- Specify a 320x460 start-up image. -->
 <link rel="apple-touch-startup-image" href="./images/bug_icon_large.png" />

 <!-- Choose a 144x144 image for the icon -->
 <link rel="apple-touch-icon" href="./images/bug_icon_sm.png" /> 

 <style>
  body {
   margin: 0px ;
   padding: 0px ;
   color: #222222;
   font-family: Helvetica;
   font-size: 14px ;
  }

  .point, .rect {
   fill: #222;
  }
</style>

<script type="text/javascript">
   // To be called when there's a move event on the body itself:
   function BlockMove(event) {
     // Tell Safari not to move the window.
     event.preventDefault() ;
   }
</script>
</head>

<body ontouchmove="blockMove(event);">
<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<script src="static/lib/d3.v3.min.js" type="text/javascript"> </script> 
<script src="static/js/d3-grid.js"></script>

<div id="container">

<h3>Instructions</h3>
<p>Try to find out which house Rover lives in. You can either click on each house, or you can ask a yes or no question like "Does his house have a window?"</p>



<script>
var img_dir_prefix = "static/images/"
var button_dir = img_dir_prefix + "buttons/"

var rects = [];
var buttons = [];

// iPad
//var screen_width = 2048,
//    screen_height = 1536;
// computer
var screen_width = 1024,
    screen_height = 768;

var bug_width = 173,
    bug_height = 169;

var button_width = 149,
    button_height = 81;

var exemplar_images = ["house_red", "house_red", "house_blue", "house_blue2"];

// set 1
var features = {"f1":"red", "f2":"blue", "f3":"window"};

var exemplars = [
  {"id":"house_red",  "f1":1, "f2":0, "f3":0},
  {"id":"house_red",  "f1":1, "f2":0, "f3":0},
  {"id":"house_blue", "f1":0, "f2":1, "f3":0},
  {"id":"house_blue2","f1":0, "f2":1, "f3":1}
  ];

var answer = exemplars[1];

var button_images = ["red", "blue", "window", "ready"];

var rectGrid = d3.layout.grid()
  .bands()
  .nodeSize([bug_width, bug_height]) 
  .padding([30, 30]); // padding is absolute if nodeSize is used
  // .size([100,100])

var buttonGrid = d3.layout.grid()
  .bands()
  .rows(1)
  .nodeSize([button_width, button_height]) 
  .padding([20, 20]);

var svg = d3.select("body").append("svg")
  .attr({
    width: screen_width,
    height: screen_height-(2.5*button_height)
  })
  .append("g")
  .attr("transform", "translate(50,40)");

//var tick = setInterval(pushAll, 500);
pushAll(exemplar_images);


var svg = d3.select("body").append("svg")
  .attr({
    width: screen_width,
    height: 2.5*button_height
  })
  .append("g")
  .attr("transform", "translate(50,10)");

pushButtons(button_images);

// var buttons = d3.select("body").selectAll("button")
//   .data(buttonGrid(buttons))
//   .enter().insert("button", ":first-child")
//     .text(function(d){ return "Add " + d;})
//     .on("click", function(d){
//       button.push(maker(d)());
//       update();
//     });


// function bugClick(d) {
//   svg.selectAll(".rect")
//     .filter(function(p) {
//       return _(d.facets).contains(p.target.name)
//     })
//     .transition()
//     .style("opacity", .9);
// }

function addImage(img, id) { 
  var rect = svg.selectAll(".rect")
    .data(rectGrid(rects));
  rect.enter().append("image")
    .attr("xlink:href", img)
    .attr("class", "rect")
    .attr("id", id)
    .attr("width", rectGrid.nodeSize()[0])
    .attr("height", rectGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1e-6)
    .on("click", function(){
      // Determine if current line is visible
      var active   = rect.active ? false : true,
        newOpacity = active ? .15 : 1;
      // Hide or show the elements
      d3.select("#"+id).style("opacity", newOpacity);
      //d3.select("#blueAxis").style("opacity", newOpacity);
      // Update whether or not the elements are active
      rect.active = active;
    });
  rect.transition()
    .delay(700)
    .attr("width", rectGrid.nodeSize()[0])
    .attr("height", rectGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1);
  rect.exit().transition()
    .delay(500)
    .style("opacity", 1e-6)
    .remove();
}


function pushAll(images) {
  shuffle(images);
  for(i=0; i<images.length; i++) {
    rects.push({});
    setTimeout(addImage("static/images/"+images[i]+".png", images[i]), 500);
  }
}

function addButton(img, id) { 
  var button = svg.selectAll(".button")
    .data(buttonGrid(buttons));
  button.enter().append("image")
    .attr("xlink:href", img)
    .attr("class", "button")
    .attr("id", id)
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .style("opacity", 1e-6)
    .on("click", function(){
      // Determine if current image is visible
      var active   = button.active ? false : true,
        newOpacity = active ? .2 : 1;
      // Hide or show the elements
      d3.select("#"+id).style("opacity", newOpacity);
      // Update whether or not the elements are active
      button.active = active;
      buttonPress(id);
    });
  button.transition()
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1);
  button.exit().transition()
    .style("opacity", 1e-6)
    .remove();
}

function pushButtons(button_images) {
  shuffle(button_images);
  for(i=0; i<button_images.length; i++) {
    buttons.push({});
    addButton(button_dir+button_images[i]+".png", button_images[i]);
  }
}

function buttonPress(id) {
  console.log(id);
  if(id=="ready") {
    d3.selectAll(".button")
      .transition()
      .style("opacity", 1e-6);
    // now treat the click on an exemplar as a guess... (modify the .on("click") function??)
  } else {
    d3.selectAll(".rect")
     .filter(function(d) {
       return _(d.facets).contains(p.target.name)
     })
     .transition()
     .style("opacity", .2);
  }
}

//@ http://jsfromhell.com/array/shuffle [v1.0]
function shuffle(o) { 
    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
}

</script>

  </div>
 </body>
</html>
