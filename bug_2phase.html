<!DOCTYPE html>
<meta charset="utf-8">

<head>
 <title>BugGuess</title>
 <!-- Prevent scaling -->
 <meta name="viewport" content="user-scalable=no, width=device-width" />
 <!-- Eliminate url and button bars if added to home screen -->
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <!-- Choose how to handle the phone status bar -->
 <meta names="apple-mobile-web-app-status-bar-style" content="black-translucent" />
 <!-- Specify a 320x460 start-up image. -->
 <link rel="apple-touch-startup-image" href="./images/bug_icon_large.png" />
 <!-- Choose a 144x144 image for the icon -->
 <link rel="apple-touch-icon" href="./images/bug_icon_sm.png" /> 


<script type="text/javascript">
   // To be called when there's a move event on the body itself:
   function BlockMove(event) {
     // Tell Safari not to move the window.
     event.preventDefault() ;
   }
</script>

<!-- external libraries -->
<script src="static/lib/jquery-min.js" type="text/javascript"> </script>
<script src="static/lib/underscore-min.js" type="text/javascript"> </script>
<script src="static/lib/backbone-min.js" type="text/javascript"> </script>
<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<script src="static/lib/d3.v3.min.js" type="text/javascript"> </script> 
<script src="static/lib/d3-grid.js"></script>

<!-- experiment code -->
<script src="static/js/stimuli.js" type="text/javascript"> </script> 

<!-- stylesheets -->
<link rel=stylesheet href="static/css/style.css" type="text/css">

</head>

<body ontouchmove="BlockMove(event);">

<div id="container">

<div class="container" id="stimArray"></div>
<div class="container" id="sideBar"></div>

<script>

// ToDo: (3/2/15)
// make exp toggle betwen two phases: ask (hypothesis or feature query) and eliminate (gray out hypotheses)
// (but also keep a version that automatically grays out eliminated options)
var condition = "automatic"; // "automatic" grays out eliminated bugs on button press; "manual" requires subjects to gray out

var img_dir_prefix = "static/images/";
var button_dir = img_dir_prefix + "buttons/";
// need a function to assign/counterbalance image_set
var image_set = "set1";
// var image_set = function getSet() {}


// iPad Retina
var screen_width = 2048,
    screen_height = 1536;


var bug_width = 330,
    bug_height = 280;

var button_width = 225,
    button_height = 118;

var sidebar_width = 380;

// set 1
var features = {"f1":"body", "f2":"eyes", "f3":"antennae", "f4":"star", "f5":"triangle", "f6":"feet", "f7":"wings", "f8":"freckles", "f9":"headband"};
// set 2
//var features = {"f1":"feet", "f2":"eyes", "f3":"triangle", "f4":"star", "f5":"wings", "f6":"headband", "f7":"body", "f8":"freckles", "f9":"antennae"};

var exemplars = [
  {"id":"A" , "f1":1 , "f2":0 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"B" , "f1":1 , "f2":1 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"C" , "f1":0 , "f2":1 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":1, "f10":0 },
  {"id":"D" , "f1":0 , "f2":1 , "f3":0 , "f4":1 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"E" , "f1":1 , "f2":0 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"F" , "f1":1 , "f2":1 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"G" , "f1":0 , "f2":1 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":1 , "f8":1 , "f9":0, "f10":0 },
  {"id":"H" , "f1":0 , "f2":1 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":1 , "f8":0 , "f9":0, "f10":0 },
  {"id":"I" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":0 , "f6":1 , "f7":0 , "f8":0 , "f9":1, "f10":0 },
  {"id":"J" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":0 , "f6":1 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"K" , "f1":0 , "f2":0 , "f3":1 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"L" , "f1":0 , "f2":0 , "f3":0 , "f4":0 , "f5":0 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"M" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":1 , "f9":0, "f10":0 },
  {"id":"N" , "f1":1 , "f2":0 , "f3":1 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"O" , "f1":0 , "f2":0 , "f3":1 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  {"id":"P" , "f1":0 , "f2":0 , "f3":0 , "f4":0 , "f5":1 , "f6":0 , "f7":0 , "f8":0 , "f9":0, "f10":0 },
  ];

var answer_ind = Math.floor((Math.random() * exemplars.length));
var answer = exemplars[answer_ind];

// varies with image set, so we need a function to return the right button set
var buttons = [
  {id:"body", "feature":"f1"},
  {id:"eyes", "feature":"f2"},
  {id:"antennae", "feature":"f3"},
  {id:"star", "feature":"f4"},
  {id:"triangle", "feature":"f5"},
  {id:"feet", "feature":"f6"},
  {id:"wings", "feature":"f7"},
  {id:"freckles", "feature":"f8"},
  {id:"headband", "feature":"f9"},
  {id:"mouth", "feature":"f10"}
//  {id:"ready"}
  ]


var rectGrid = d3.layout.grid()
  .bands()
  .nodeSize([bug_width, bug_height]) 
  .padding([30, 20]); // padding is absolute if nodeSize is used
  // .size([100,100])

var buttonGrid = d3.layout.grid()
  .bands()
  .rows(2)
  .nodeSize([button_width, button_height]) 
  .padding([50, 30]);

var bugs = d3.select("#stimArray").append("svg")
  .attr({
    width: screen_width-sidebar_width,
    height: screen_height-(2.5*button_height)
  }) 
  .attr("id", "bugArray")
  .append("g")
  .attr("transform", "translate(50,40)");


addImages(exemplars, img_dir_prefix+image_set+"/");

var sidebar = d3.select("#sideBar").append("svg")
  .attr({
    width: sidebar_width,
    height: screen_height-(2.5*button_height)
  }) 
  .attr("id", "sidebar");



var rug = sidebar.append("g")
  .attr("id", "rug")
  .attr("transform", "translate(20,50)")
  .append("image")
  .attr("xlink:href", function(d) { return "static/images/rug.png"; })
  .attr({
    width: 261,
    height: 437
  })
  .style("opacity", 1)
  .on("mousedown", function(d) {
    d3.select(this).transition()
      .attr("width",261+50)
      .duration(1000) // this is 1s
      .delay(100);
    d3.select(this).transition()
      .attr("width",261)
      .duration(500)
      .delay(100);
  });

//function wiggle(d) {}

var callout = sidebar.append("g")
  .attr("id", "callout")
  .attr("transform", "translate(0,490)");

callout.append("image")
  .attr("xlink:href", function(d) { return "static/images/callout.svg"; })
  .attr({
    width: 300,
    height: 250
  })
  .style("opacity", 1);
  //.attr("transform", "translate(0,0)");

var text = callout
  .append("text")
  .attr("x", 32)
  .attr("y", 140)
  .attr("style", "font-size: 50; font-family: Helvetica, sans-serif")
  .text("Who am I?")
  .attr("fill", "black");

var buttonbar = d3.select("#container").append("svg")
  .attr({
    width: screen_width-sidebar_width,
    height: 2.5*button_height
  })
  .attr("id", "buttonArray")
  .append("g")
  .attr("transform", "translate(50,10)");

addButtons(buttons);

var div = d3.select("#container").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

// var dialog = d3.select("g")
//   .append("svg:rect")
//   .attr("id", "dialog")
//   .attr("x", 490)
//   .attr("y", 470)
//   .attr("height", 200)
//   .attr("width", 400)
//   .attr("fill", "#999999")
//   .style("opacity", 1e-6);


function addImages(exemplars, img_dir) { 
  //shuffle(exemplars);
  var rect = bugs.selectAll(".rect")
    .data(rectGrid(exemplars)); 
  console.log(rect)
  rect.enter().append("image")
    .attr("xlink:href", function(d) { return img_dir+d.id+".png"; })
    .attr("class", "rect")
    .attr("id", function(d) { return d.id; })
    .attr("width", rectGrid.nodeSize()[0])
    .attr("height", rectGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1e-6)
    .on("mousedown", function(d){
      // Determine if current line is visible
      var active   = rect.active ? false : true,
        newOpacity = active ? .2 : 1;
      // Hide or show the elements
      //d3.select("#"+d.id).style("opacity", newOpacity);
      // Update whether or not the elements are active
      rect.active = active;

      // do the 1-click test for now (otherwise use ready button state)
      if(d.id===answer.id) {
          //.attr("xlink:href", function(d) { return img_dir_prefix+"smiley.svg"; })
        var correct = d3.select("g").append("image")
          .attr("xlink:href", function(d) { return img_dir_prefix+"smiley.svg"; })
          .attr("id", "correct")
          .attr("x", 490)
          .attr("y", 430)
          .attr("height", 400)
          .attr("width", 400)
          .style("opacity", 1)
          .on("mousedown", function(d) { correct.remove() });
        correct.transition().duration(1000).delay(1000).style("opacity", 1e-6);
      } else {
        d3.select("#"+d.id).style("opacity", newOpacity);
        //incorrect.style("opacity", 1);
        //incorrect.transition().delay(2000).style("opacity", 1e-6);
        var incorrect = d3.select("g").append("image")
          .attr("xlink:href", function(d) { return img_dir_prefix+"red_x.svg"; })
          .attr("id", "incorrect")
          .attr("x", d.x + 25)
          .attr("y", d.y)
          .attr("height", rectGrid.nodeSize()[0])
          .attr("width", rectGrid.nodeSize()[1])
          .style("opacity", 1)
          .on("mousedown", function(d) { incorrect.remove(); });
        incorrect.transition().duration(1000).delay(1000).style("opacity", 1e-6);
        }
      });
  rect.transition()
    .delay(500)
    .attr("width", rectGrid.nodeSize()[0])
    .attr("height", rectGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1);
  rect.exit().transition()
    .style("opacity", 1e-6)
    .remove();
}

function addButtons(buttons) { 
  //shuffle(buttons);
  var button = buttonbar.selectAll(".button")
    .data(buttonGrid(buttons));
  button.enter().append("image")
    .attr("xlink:href", function(d) { return button_dir+d.id+".png"; })
    .attr("class", "button")
    .attr("id", function(d) { return d.id; })
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .style("opacity", 1e-6)
    .on("mousedown", function(d){
      // press once and remain active (unless ready button..)
      d3.select("#"+d.id).style("opacity", .2); //
      button.active = true;
      buttonPress(d);
    });
  button.transition()
    .attr("width", buttonGrid.nodeSize()[0])
    .attr("height", buttonGrid.nodeSize()[1])
    .attr("transform", function(d) { return "translate(" + (d.x + 20)+ "," + d.y + ")"; })
    .style("opacity", 1);
  // could add a toggle 'ready' button here if desired
}


function buttonPress(b) {
  console.log(b);
  if(b.id=="ready") {
    d3.selectAll(".button")
      .transition()
      .style("opacity", 1e-6);
    // now treat the click on an exemplar as a guess... (modify the .on("click") function??)
  } else {
    // select the rects that do not have the answer's d[b.feature] 
    if(condition==="automatic") {
    d3.selectAll(".rect")
     .filter(function(d) {
       return d[b.feature] !== answer[b.feature];
     })
     .style("opacity", .2).attr("active", true);
   } else if(condition==="manual") {
     text.remove();
     var tmp = callout.append("text")
       .attr("x", 32)
       .attr("y", 140)
       .attr("style", "font-size: 40; font-family: Helvetica, sans-serif")
       .text("Feature: "+b.id+":"+answer[b.feature])
       .attr("fill", "black");
     tmp.transition()
       .delay(4000)
       .style("opacity", 1e-6)
       .remove();
     }
  }
  // OR show them a dialog with the correct feature in it
  // tooltip with image in it:
  // http://bl.ocks.org/jarobertson/1483052
}

//@ http://jsfromhell.com/array/shuffle [v1.0]
function shuffle(o) { 
  for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
  return o;
}

</script>
  
   </div>
 </body>
</html>